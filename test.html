<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grab minimal - test</title>
<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
<script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

<script>
AFRAME.registerComponent('defer-grabbable', {
  schema: { enableOnModelLoaded: {default: true} },
  init() {
    // Si c'est un modèle glTF, n'activer grabbable qu'après model-loaded
    if (this.el.tagName.toLowerCase() === 'a-asset-item' || this.el.getAttribute('gltf-model')) {
      this.el.addEventListener('model-loaded', () => {
        if (!this.el.hasAttribute('grabbable')) this.el.setAttribute('grabbable', '');
      }, {once: true});
      // retirer tout grabbable présent tant que le modèle charge
      if (this.el.hasAttribute('grabbable')) this.el.removeAttribute('grabbable');
    } else {
      // élément simple : s'assurer qu'il est grabbable
      if (!this.el.hasAttribute('grabbable')) this.el.setAttribute('grabbable', '');
    }
  }
});

// Composant pour éviter multi-grab/conflict : lock pendant le grab
AFRAME.registerComponent('safe-grab', {
  init() {
    this.onStart = (e) => {
      const el = e.target || e.detail?.target || this.el;
      if (!el) return;
      // marquer comme grabbed pour empêcher double handlers
      el.setAttribute('data-is-grabbed','true');
      // supprimer temporairement grabbable sur les enfants si besoin
      el.querySelectorAll('[grabbable]').forEach(c => {
        if (c !== el) c.removeAttribute('grabbable');
      });
    };
    this.onEnd = (e) => {
      const el = e.target || e.detail?.target || this.el;
      if (!el) return;
      el.removeAttribute('data-is-grabbed');
      // remettre éventuellement grabbable sur les enfants (si tu veux)
      // el.querySelectorAll('.may-be-grabbable').forEach(c => c.setAttribute('grabbable',''));
    };
    this.el.addEventListener('grab-start', this.onStart);
    this.el.addEventListener('grab-end', this.onEnd);
  },
  remove() {
    this.el.removeEventListener('grab-start', this.onStart);
    this.el.removeEventListener('grab-end', this.onEnd);
  }
});
</script>
</head>
<body>
<a-scene renderer="antialias: true">
  <!-- rig à la bonne hauteur (1.6m) -->
  <a-entity id="rig" position="0 1.6 0">
    <a-entity camera look-controls wasd-controls></a-entity>

    <!-- mains -->
    <a-entity id="leftHand" hand-controls="hand: left" super-hands sphere-collider="objects: .grabbable"></a-entity>
    <a-entity id="rightHand" hand-controls="hand: right" super-hands sphere-collider="objects: .grabbable"></a-entity>
  </a-entity>

  <!-- sol -->
  <a-plane rotation="-90 0 0" width="20" height="20" color="#7BC8A4"></a-plane>

  <!-- objets simples (fonctionnent d'emblée) -->
  <a-box class="grabbable" position="-0.5 1.2 -1.2" color="#4CC3D9"
         grabbable hoverable draggable safe-grab></a-box>

  <!-- exemple import glTF : grabbable activé seulement après model-loaded -->
  <!-- remplace src par ton modèle si tu veux tester -->
  <a-entity class="grabbable" gltf-model="https://cdn.aframe.io/test-models/models/box/box.gltf"
            position="0.5 1.2 -1.2" defer-grabbable safe-grab></a-entity>

  <a-text value="Test grab. Si ça pète, copie la console." position="-0.9 2 -1.5" width="3"></a-text>
</a-scene>
</body>
</html>

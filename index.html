<html>
  <head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physx@master/dist/physx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physx@master/dist/physx.release.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physx@master/dist/physx.release.wasm.js"></script>

  </head>
  <body>
    <a-scene
    renderer="antialias: true"
    physics="driver: physx; wasmUrl: https://cdn.jsdelivr.net/gh/n5ro/aframe-physx@master/dist/physx.release.wasm"
    xr-mode-ui="enabled: true">

    <!-- Camera rig -->
    <a-entity id="rig" position="0 1.6 0">
        <a-camera></a-camera>

        <a-entity
        id="left"
        laser-controls="hand: left"
        super-hands
        sphere-collider="objects: .grabbable"
        stretchable grabbable></a-entity>

        <a-entity
        id="right"
        laser-controls="hand: right"
        super-hands
        sphere-collider="objects: .grabbable"
        stretchable grabbable></a-entity>
    </a-entity>

    <!-- Sol -->
    <a-plane static-body rotation="-90 0 0" width="20" height="20" color="#888"></a-plane>

    <!-- Objet dynamique -->
    <a-box position="0 2 -3"
            width="0.5" height="0.5" depth="0.5"
            color="red"
            class="grabbable"
            physx-body="type: dynamic; mass: 1;"
            physics-grab></a-box>

    </a-scene>


  </body>

  <script>
    AFRAME.registerComponent('joystick-locomotion', {
      schema: {
        moveSpeed: { type: 'number', default: 0.1 },
        turnSpeed: { type: 'number', default: 2 },
        deadZone: { type: 'number', default: 0.01 }
      },

      init() {
        this.leftGamepad = null;
        this.rightGamepad = null;

        this.el.sceneEl.addEventListener('enter-vr', () => {
          const xrSession = this.el.sceneEl.renderer.xr.getSession();
          if (!xrSession) return;

          xrSession.addEventListener('inputsourceschange', () => {
            this.updateControllers(xrSession);
          });

          this.updateControllers(xrSession); // aussi au premier enter-vr
        });
      },

      updateControllers(xrSession) {
        const inputSources = xrSession.inputSources;
        this.leftGamepad = null;
        this.rightGamepad = null;

        inputSources.forEach((source) => {
          if (!source.gamepad) return;

          if (source.handedness === 'left') {
            this.leftGamepad = source.gamepad;
          } else if (source.handedness === 'right') {
            this.rightGamepad = source.gamepad;
          }
        });
      },

      tick() {
        const rig = this.el;
        const pos = rig.getAttribute('position');
        const rot = rig.getAttribute('rotation');

        // === Déplacement avec stick gauche ===
        if (this.leftGamepad && this.leftGamepad.axes.length >= 2) {
          const [lx, ly] = [this.leftGamepad.axes[2], this.leftGamepad.axes[3]];
          const mag = Math.sqrt(lx * lx + ly * ly);

          if (mag > this.data.deadZone) {
            console.log("aaa");
            const angleRad = THREE.MathUtils.degToRad(rot.y);
            const dx = (-ly * Math.sin(angleRad) + lx * Math.cos(angleRad)) * this.data.moveSpeed;
            const dz = (-ly * Math.cos(angleRad) - lx * Math.sin(angleRad)) * this.data.moveSpeed;

            rig.setAttribute('position', {
              x: pos.x + dx,
              y: pos.y,
              z: pos.z - dz
            });
          }
        }

        // === Rotation avec stick droit ===
        if (this.rightGamepad && this.rightGamepad.axes.length >= 4) {
          const [rx, ry] = [this.rightGamepad.axes[2], this.rightGamepad.axes[3]];
          if (Math.abs(rx) > this.data.deadZone) {
            rig.setAttribute('rotation', {
              x: rot.x,
              y: rot.y - rx * this.data.turnSpeed,
              z: rot.z
            });
          }
        }
      }
    });


    AFRAME.registerComponent("physics-grab", {
        init: function () {
            let el = this.el;

            el.addEventListener("grab-start", function () {
            el.setAttribute("physx-body", "type: kinematic;"); // désactive la gravité
            });

            el.addEventListener("grab-end", function () {
            el.setAttribute("physx-body", "type: dynamic;"); // réactive
            });
        }
    });

    
  </script>
</html>